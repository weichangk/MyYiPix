# 服务启动指南

## 前置条件

- .NET 9 SDK
- Docker Desktop（已启动，引擎状态为绿色）

---

## 第一步：启动基础设施

```powershell
cd docker
docker compose -f docker-compose.infra.yml up -d
```

验证容器状态：

```powershell
docker compose -f docker-compose.infra.yml ps
```

确认 3 个容器均为 **Up** 状态：

| 容器 | 端口 |
|------|------|
| yipix-postgres | `localhost:5432` |
| yipix-redis | `localhost:6379` |
| yipix-rabbitmq | `localhost:5672` / 管理界面 `http://localhost:15672`（guest/guest） |

---

## 第二步：编译项目

```powershell
cd E:\.net\MyYiPix
dotnet build YiPix.sln
```

---

## 第三步：启动服务

### 方式 A：启动单个服务（日常开发推荐）

```powershell
# 在项目根目录执行
dotnet run --project src/Services/AuthService
```

### 方式 B：一键启动所有服务

```powershell
# 在项目根目录执行
.\start-all.ps1
```

停止所有服务：

```powershell
.\stop-all.ps1
```

### 方式 C：全量 Docker 部署

所有服务都运行在容器中，不需要本地 `dotnet run`：

```powershell
cd docker
docker compose up --build -d
```

停止：

```powershell
docker compose down
```

---

## 服务清单

### 9 个 API 服务

| 服务 | 启动命令 |
|------|----------|
| AuthService | `dotnet run --project src/Services/AuthService` |
| UserService | `dotnet run --project src/Services/UserService` |
| SubscriptionService | `dotnet run --project src/Services/SubscriptionService` |
| PaymentService | `dotnet run --project src/Services/PaymentService` |
| DownloadService | `dotnet run --project src/Services/DownloadService` |
| ProductService | `dotnet run --project src/Services/ProductService` |
| AnalyticsService | `dotnet run --project src/Services/AnalyticsService` |
| TaskService | `dotnet run --project src/Services/TaskService` |
| FileService | `dotnet run --project src/Services/FileService` |

### 3 个后台 Worker

| Worker | 启动命令 |
|--------|----------|
| AIWorker | `dotnet run --project src/Workers/AIWorker` |
| WebhookWorker | `dotnet run --project src/Workers/WebhookWorker` |
| AnalyticsWorker | `dotnet run --project src/Workers/AnalyticsWorker` |

---

## 启动方式对比

| | 方式 A（单个启动） | 方式 B（脚本启动） | 方式 C（Docker 全量） |
|---|---|---|---|
| **适用场景** | 日常开发调试 | 本地联调多个服务 | 集成测试 / 演示 / 部署 |
| **修改代码后** | 自动热重载 | 需重启脚本 | 需 `docker compose up --build` |
| **资源占用** | 最低 | 中等 | 较高 |
| **推荐程度** | 日常首选 | 联调时用 | 部署时用 |

---

## 查看 API 文档

所有 API 服务已集成 [Scalar](https://github.com/scalar/scalar) 文档界面，启动服务后浏览器访问：

```
http://localhost:{端口}/scalar/v1
```

| 服务 | Scalar 文档地址 |
|------|----------------|
| AuthService | `http://localhost:5282/scalar/v1` |
| UserService | `http://localhost:{port}/scalar/v1` |
| SubscriptionService | `http://localhost:{port}/scalar/v1` |
| PaymentService | `http://localhost:{port}/scalar/v1` |
| DownloadService | `http://localhost:{port}/scalar/v1` |
| ProductService | `http://localhost:{port}/scalar/v1` |
| AnalyticsService | `http://localhost:{port}/scalar/v1` |
| TaskService | `http://localhost:{port}/scalar/v1` |
| FileService | `http://localhost:{port}/scalar/v1` |

> 具体端口以各服务启动时终端输出的 `Now listening on: http://localhost:xxxx` 为准。

OpenAPI JSON 原始文档：`http://localhost:{端口}/openapi/v1.json`

---

## 常见问题

### Q: 启动服务报 DbCommand 错误？

首次运行需要创建数据库迁移：

```powershell
cd src/Services/AuthService
dotnet ef migrations add InitialCreate
dotnet ef database update
```

每个服务都需要单独创建迁移。

### Q: Docker 基础设施连不上？

确认 Docker Desktop 已启动且容器正在运行：

```powershell
docker compose -f docker/docker-compose.infra.yml ps
```

### Q: 如何查看服务日志？

- 单个服务：终端直接输出
- 脚本启动：`Receive-Job -Name AuthService`
- Docker 部署：`docker compose logs -f auth-service`
