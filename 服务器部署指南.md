# 服务器部署指南

## 服务器要求

| 项目 | 最低配置 | 推荐配置 |
|------|----------|----------|
| **OS** | Ubuntu 22.04 / CentOS 8+ | Ubuntu 24.04 LTS |
| **CPU** | 2 核 | 4 核+ |
| **内存** | 4 GB | 8 GB+ |
| **硬盘** | 40 GB SSD | 100 GB SSD |
| **软件** | Docker + Docker Compose | 同左 |

---

## 第一步：服务器安装 Docker

```bash
# Ubuntu
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
# 重新登录使 docker 组生效
```

验证：

```bash
docker --version
docker compose version
```

---

## 第二步：上传代码到服务器

### 方式 A：Git 拉取（推荐）

```bash
cd /opt
git clone https://your-repo-url/yipix-backend.git
cd yipix-backend
```

### 方式 B：本地打包上传

```powershell
# 本地 Windows 执行
tar -czf yipix-backend.tar.gz --exclude=node_modules --exclude=bin --exclude=obj .
scp yipix-backend.tar.gz user@server-ip:/opt/
```

```bash
# 服务器执行
cd /opt
mkdir yipix-backend && cd yipix-backend
tar -xzf ../yipix-backend.tar.gz
```

---

## 第三步：配置环境变量

```bash
cd docker
cp .env.example .env
nano .env
```

填入生产环境的实际值：

```env
POSTGRES_USER=yipix_prod
POSTGRES_PASSWORD=生成一个强密码
POSTGRES_DB=yipix
RABBITMQ_USER=yipix
RABBITMQ_PASSWORD=生成一个强密码
REDIS_PASSWORD=生成一个强密码
JWT_SECRET=至少32字符的随机字符串
JWT_ISSUER=YiPix
JWT_AUDIENCE=YiPixClients
ASPNETCORE_ENVIRONMENT=Production
```

生成强密码：

```bash
openssl rand -base64 32
```

> ⚠️ `.env` 文件已在 `.gitignore` 中排除，不会被提交到仓库。

---

## 第四步：启动服务

```bash
cd /opt/yipix-backend/docker

# 构建镜像并后台启动
docker compose -f docker-compose.prod.yml up --build -d
```

首次启动需要拉取基础镜像和编译，大约 5-10 分钟。

---

## 第五步：验证部署

```bash
# 查看所有容器状态
docker compose -f docker-compose.prod.yml ps

# 查看日志
docker compose -f docker-compose.prod.yml logs -f

# 测试 API
curl http://localhost:5001/api/auth/health
curl http://localhost/health   # 通过 Nginx
```

---

## 第六步：配置域名和 SSL

### 1. DNS 解析

将 `api.yipix.com`（或你的域名）A 记录指向服务器 IP。

### 2. 申请 SSL 证书（Let's Encrypt）

```bash
# 安装 certbot
sudo apt install certbot -y

# 先停止 nginx 容器释放 80 端口
docker compose -f docker-compose.prod.yml stop nginx

# 申请证书
sudo certbot certonly --standalone -d api.yipix.com

# 复制证书到项目目录
sudo cp /etc/letsencrypt/live/api.yipix.com/fullchain.pem docker/nginx/ssl/
sudo cp /etc/letsencrypt/live/api.yipix.com/privkey.pem docker/nginx/ssl/
```

### 3. 启用 HTTPS

编辑 `docker/nginx/nginx.conf`，取消 HTTPS server 块的注释，然后重启：

```bash
docker compose -f docker-compose.prod.yml restart nginx
```

---

## 日常运维命令

```bash
# 查看容器状态
docker compose -f docker-compose.prod.yml ps

# 查看某个服务日志
docker compose -f docker-compose.prod.yml logs -f auth-service

# 重启某个服务
docker compose -f docker-compose.prod.yml restart auth-service

# 更新代码后重新部署
git pull
docker compose -f docker-compose.prod.yml up --build -d

# 仅重建某个服务
docker compose -f docker-compose.prod.yml up --build -d auth-service

# 进入 PostgreSQL
docker compose -f docker-compose.prod.yml exec postgres psql -U yipix_prod -d yipix

# 数据库备份
docker compose -f docker-compose.prod.yml exec postgres pg_dump -U yipix_prod yipix > backup_$(date +%Y%m%d).sql

# 数据库还原
cat backup.sql | docker compose -f docker-compose.prod.yml exec -T postgres psql -U yipix_prod -d yipix

# 停止所有服务
docker compose -f docker-compose.prod.yml down

# 停止并删除数据（危险！）
docker compose -f docker-compose.prod.yml down -v
```

---

## 文件结构说明

```
docker/
├── docker-compose.infra.yml      # 本地开发：仅基础设施
├── docker-compose.yml            # 本地全量：开发环境
├── docker-compose.prod.yml       # 生产部署：含 Nginx + 环境变量
├── .env.example                  # 环境变量模板
├── .env                          # 实际环境变量（不提交 Git）
├── nginx/
│   ├── nginx.conf                # Nginx 反向代理配置
│   └── ssl/                      # SSL 证书目录
│       ├── fullchain.pem
│       └── privkey.pem
├── Dockerfile.auth               # AuthService 镜像
├── Dockerfile.user               # UserService 镜像
├── Dockerfile.subscription       # SubscriptionService 镜像
├── Dockerfile.payment            # PaymentService 镜像
├── Dockerfile.download           # DownloadService 镜像
├── Dockerfile.product            # ProductService 镜像
├── Dockerfile.analytics          # AnalyticsService 镜像
├── Dockerfile.task               # TaskService 镜像
├── Dockerfile.file               # FileService 镜像
├── Dockerfile.aiworker           # AIWorker 镜像
├── Dockerfile.webhookworker      # WebhookWorker 镜像
├── Dockerfile.analyticsworker    # AnalyticsWorker 镜像
└── Dockerfile.base               # 基础 Dockerfile 模板
```

---

## 架构图（生产环境）

```
用户请求
   │
   ▼
[ 域名 api.yipix.com ]
   │
   ▼
[ Nginx :80/:443 ] ──── SSL 终止 + 反向代理
   │
   ├─ /api/auth ──────► auth-service:8080
   ├─ /api/users ─────► user-service:8080
   ├─ /api/subscriptions → subscription-service:8080
   ├─ /api/payments ──► payment-service:8080
   ├─ /api/downloads ─► download-service:8080
   ├─ /api/products ──► product-service:8080
   ├─ /api/analytics ─► analytics-service:8080
   ├─ /api/tasks ─────► task-service:8080
   └─ /api/files ─────► file-service:8080
                            │
                    ┌───────┴───────┐
                    ▼               ▼
              [ PostgreSQL ]  [ RabbitMQ ]
              [ Redis ]       [ Workers  ]
```

---

## 安全清单

- [ ] `.env` 使用强密码，不提交 Git
- [ ] 基础设施端口只绑定 `127.0.0.1`（不暴露到公网）
- [ ] 启用 HTTPS + SSL 证书
- [ ] 服务器防火墙只开放 80/443 端口
- [ ] 定期备份数据库
- [ ] `ASPNETCORE_ENVIRONMENT=Production`（关闭 Scalar 文档）
- [ ] RabbitMQ 管理界面不暴露到公网
